name: Build and Deploy

on:
  push:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  setup:
    name: Merge Repos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout chobble-template
        uses: actions/checkout@v4
        with:
          repository: chobbledotcom/chobble-template
          path: template

      - name: Combine files
        run: |
          rsync \
            --recursive \
            --verbose \
            --delete \
            --exclude=".git" \
            --exclude="*.md" \
            template/ \
            combined/

          rsync \
            --recursive \
            --verbose \
            --exclude=".*" \
            --exclude="README.md" \
            --exclude="package.json" \
            --exclude="bun.lock" \
            source/ \
            combined/src/

      - name: Inject secrets into config
        run: |
          cd combined/src/_data
          jq '.formspark_id = "${{ secrets.FORMSPARK_ID }}" | .botpoison_public_key = "${{ secrets.BOTPOISON_PUBLIC_KEY }}"' config.json > config.tmp.json && mv config.tmp.json config.json

      - name: Verify .eleventy.js exists
        run: |
          ls -la combined/.eleventy.js
          ls -la combined/src/_layouts/ | head -5

      - name: Upload combined directory
        uses: actions/upload-artifact@v4
        with:
          name: combined-site
          path: combined
          include-hidden-files: true
          retention-days: 1

  build:
    name: Build Site
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Download combined site
        uses: actions/download-artifact@v4
        with:
          name: combined-site
          path: site

      - name: Verify downloaded files
        run: |
          ls -la site/.eleventy.js
          ls -la site/src/_layouts/ | head -5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            site/node_modules
            site/.image-cache
          key: ${{ runner.os }}-bun-${{ hashFiles('site/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          cd site
          bun install --frozen-lockfile

      - name: Build site
        run: |
          cd site
          bun run build

      - name: Deploy to Bunny
        uses: R-J-dev/bunny-deploy@v2.0.6
        with:
          access-key: ${{ secrets.BUNNY_ACCESS_KEY }}
          directory-to-upload: site/_site
          storage-endpoint: "https://storage.bunnycdn.com"
          storage-zone-name: "veganprestwich"
          storage-zone-password: ${{ secrets.BUNNY_STORAGE_ZONE_PASSWORD }}
          concurrency: "5"
          enable-delete-action: true
          enable-purge-pull-zone: true
          pull-zone-id: "4583153"
          replication-timeout: "15000"

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: failure()
    steps:
      - name: Send failure notification
        uses: NiNiyas/ntfy-action@master
        with:
          url: 'https://ntfy.sh'
          topic: ${{ secrets.NTFY_TOPIC }}
